# Chain Configuration

After unzipping the release package, or compiling the source code, don't hurry to start the node. Before that, an important step is that we need to initialize the chain before starting it.
In the initialization process, all the configuration information will be written into the genesis block. Once the genesis block is generated, in SysConfig, only three items `chainName`, `operator`, `website`  can be modified while the other items can no longer be changed. So please carefully set each configuration item.
In CITA, we provide the Config Tool to help you initialize the chain, and we also offer a command line tool named CITA-CLI to help you modify several specific configurations while the chain is already running.

This document will introduce the configurable items in CITA, including the attributes of the chain itself, system contracts, RPC interfaces, network connections between nodes, etc.;
Then through a specific operation example, demonstrate how to initialize the chain before starting it;
And take you in detail to understand the directory structure of the file after the initial configuration;
Finally, an operation example will be used to demonstrate how to modify some particular configurations after starting the chain.
Though this document, you will be able to customize a chain that meets your needs.

## Configurable Items

Run the following command to view each configurable item:

```shell
$ ./env.sh ./scripts/create_cita_config.py create --help
usage: create_cita_config.py create [-h]
                                    [--authorities AUTHORITY[,AUTHORITY[,AUTHORITY[,AUTHORITY[, ...]]]]]
                                    [--chain_name CHAIN_NAME]
                                    [--nodes IP:PORT[,IP:PORT[,IP:PORT[,IP:PORT[, ...]]]]]
                                    [--super_admin SUPER_ADMIN]
                                    [--contract_arguments Contract.Argument=Value [Contract.Argument=Value ...]]
                                    [--timestamp TIMESTAMP]
                                    [--resource_dir RESOURCE_DIR]
                                    [--grpc_port GRPC_PORT]
                                    [--jsonrpc_port JSONRPC_PORT]
                                    [--ws_port WS_PORT]
                                    [--enable_tls]
```

Explain it one by one:

> **Notice**
> If you want to start the chain, it is strictly required to configure `super_admin` and `nodes`, since for these two, system does not provide any default configuration.

### `--authorities` write the addresses of the consensus nodes to the genesis block
* For security concerns, we highly recommend: generate each private key and address independently by each consensus node. The private key must be kept by node self while the address should be handed over to the administrator who takes responsibility to start the chain. After receiving all the addresses，administrator can use this command to write all these addresses to the genesis block. After starting the chain, `test-chain/*/privkey` file would be empty, and each consensus node fills in its private key individually.
* If no parameters are passed, the private key/address pair corresponding to the number of nodes is automatically generated by default: the address is written into the chain; the private key is stored in the `test-chain/*/privkey` file of each consensus node.

### `--chain_name` specify the name of the chain
* After executing this command, a folder named `chain_name` will be generated. Inside this folder, several folders such as 0, 1, and 2 will be created according to the node number, in which the node configuration files will be stored.
* If you don't pass the `chain_name` parameter, the default chain name would be `test-chain`.

### `--nodes` specify the IP and the port of each node
Each node needs to provide IP and port, so to connect to others. When passing the parameter, IP and port are separated by a colon, and different nodes are separated by commas. Finally, a corresponding number of consensus nodes will be generated according to how many network addresses are passed in this parameter (the maximum limit is 256). The node numbers will start from 0 and then increment according to the order of the network addresses in the parameters.

### `--super_admin` specify the address of the super administrator
This account has the highest authority to manage the running status of the entire chain. Users ** must ** set up the super administrator by self.

### `--contract_arguments` specify configuration of the chain itself and the configuration of the system contract
We can find an example configuration file `init_data.yml` in the `test-chain/template` directory. Each configuration item is as follows:

```
-Contracts:
 -SysConfig:
   delayBlockNumber: 1
   checkCallPermission: false
   checkSendTxPermission: false
   checkCreateContractPermission: false
   checkQuota: false
   checkFeeBackPlatform:false
   chainOwner: '0x0000000000000000000000000000000000000000'
   chainName: test-chain
   chainId: 1
   operator: test-operator
   website: https://www.example.com (https://www.example.com/)
   blockInterval: 3000
   economicalModel: 0
   name: Nervos AppChain Test Token
   symbol: NATT
   avatar: https://cdn.cryptape.com/icon_appchain.png
 -QuotaManager:
   admin: '0x4b5ae4567ad5d9fb92bc9afd6a657e6fa13a2523'
 -NodeManager:
   nodes:
   '0x4b5ae4567ad5d9fb92bc9afd6a657e6fa13a2523'
   stakes:
   0
 -ChainManager:
   parentChainId: 0
   parentChainAuthorities: []
 -Authorization:
   superAdmin: '0x4b5ae4567ad5d9fb92bc9afd6a657e6fa13a2523'
 -Group:
   parent: '0x0000000000000000000000000000000000000000'
   name: rootGroup
   accounts:
   '0x4b5ae4567ad5d9fb92bc9afd6a657e6fa13a2523'
 -Admin:
   admin: '0x4b5ae4567ad5d9fb92bc9afd6a657e6fa13a2523'
 -VersionManager:
   version: 1
```

* `SysConfig` : initialize some system information
  - `delayBlockNumber` : indicates that the system contract takes effect after several blocks. The default is 1 block. Deprecation now.
  - `checkCallPermission` : contract call permission switch
  - `checkSendTxPermission` : send transaction permission switch
  - `checkCreateContractPermission` : contract create permission switch
  - `checkQuota` : quota switch
  - `checkFeeBackPlatform` : feeback switch, the default is `false`, which means return to the address of consensus node, while `true` means return to a certain address set by chain owner
  - `autoExec` : autoExec switch, the default is `false`. while `true` means turn on the autoExec feature
  - `chainOwner` : a certain address set by chain owner, used when `checkFeeBackPlatform` is `true`
  - `chainName` : the name of the chain
  - `chainId` : chain Id
  - `operator` : operator name
  - `website` : operator website
  - `blockInterval` : block interval, default is 3 seconds
  - `economicalModel`: economic model. There are two economic models designed in CITA, Quota (default) and Charge. `economicalModel = 0` is building the Quota model, which means the transaction can be accepted only if the quota required for this transaction is not exceed the account limit and block limit set by administrator. More details can be refered to [Quota Management](./system_management/quota). `economicalModel = 1` is building the Charge model, which means the transaction requires a fee. The single-step deduction mode is executed for each step of the transaction. More details can be refered to [Quota Price Management](./system_management/quota_price).
  - `name` : token name
  - `symbol` : token symbol
  - `avatar` : link of token icon
* `QuotaManager` : initialize the administrator address
  - `admin` : default administrator address
* `NodeManager` : initialize consensus node management contract
  - `nodes` : consensus node address
  - `stakes` : the weight of consensus nodes to produce the block
* `ChainManager` : initialize some information for cross-chain
  - `parentChainId` : parent chain ID
  - `parentChainAuthorities` : list of consensus nodes for the parent chain
* `Authorization` : initialize the administrator address
  - `superAdmin` : administrator address
* `Group` : initialize user group
  - `parent` : the address of the parent group
  - `name` : the name of the group
  - `accounts` : list of users in the group
* `Admin` : administrator
  - `admin` : administrator address
* `VersionManager` : protocol version
  - `version` : protocol version number
* `PriceManager` : quota price management contract
  - `quotaPrice` : quota price value

### `--time_stamp` specify the start timestamp
* The value passed in this parameter is the number of milliseconds since 1970-1-1. The default is to take the current time. If the time is set as future time, the block cannot be produced successfully after starting the chain.
* This value can be viewed in genesis.son file after the initialization.

### `--resource_dir` specify the resource directory
* In addition to the arrays in the Genesis block, the chain sometimes needs to carry some additional data (such as zero-knowledge proof). But because the data is too large to fit into the Genesis block, you can specify a separate resource directory by passing parameters here.
* After specifying this parameter, one more resource directory will be generated. The files in the user-specified directory will be copied in. Then, the configuration tool will calculate the hash value of all files in the directory as the prevhash field in `genesis.json`. The prevhash default is all 0.

### `--grpc_port`、`jsonrpc_port`、`ws_port` specify the starting port number
* The port number specified by the parameters gRPC, JSON-RPC, WebSocket, etc. is a starting port number. The port number actually used by the node is deferred according to the order of nodes, that is, port+n (n is the node number). For example, a total of 4 nodes, passing the grpc_port parameter to 7000. The gRPC port number of test-chain/0 is 7000, the gRPC port number of test-chain/1 is 7001, and same in after.
* grpc_port is stored in `test-chain/*/executor.toml` ，jsonrpc port and ws port are stored in `test-chain/*/jsonrpc.toml`.
* CITA has some reserved ports, so it is necessary to avoid port conflicts when setting node network ports, or custom ports. Reserved ports are:
  * Default `grpc` port: 5000 to 5000 + N (N is the total number of nodes, the same below)
  * Default `jsonrpc` port: 1337 to 1337 + N
  * Default `websocket` port: 4337 to 4337+N
  * Default `rabbitmq` port: 4369(epmd)/25672(Erlang distribution)/5671,5672(AMQP)/15672(management plugin)

###  `--enable_tls` whether to enable communication encryption
* Specifies whether the data transferred between nodes is encrypted using TLS (Transport Layer Security). Without this option, the default is unencrypted transmission.
* Adding this option when creating a chain will add `enable = true` to the network.toml and `common_name = ${chain_name}.cita` in each peer. Otherwise the configuration items are not generated in `network.toml`.

## Initial configuration operation example

The following is the command to start a most basic chain with four nodes. The default port is 4000, 4001, 4002, 4003. The economic model is `Quota`, and all permission controls are closed.

```shell
$ ./env.sh ./scripts/create_cita_config.py create --super_admin "0x4b5ae4567ad5d9fb92bc9afd6a657e6fa13a2523" --nodes "127.0.0.1:4000,127.0.0.1:4001,127.0.0.1:4002,127.0.0.1:4003"
```

The following command is to generate a chain with quite advanced configurations:

```shell
$ ./env.sh ./scripts/create_cita_config.py create --super_admin "0x4b5ae4567ad5d9fb92bc9afd6a657e6fa13a2523" --nodes "127.0.0.1:4000,127.0.0.1:4001,127.0.0.1:4002,127.0.0.1:4003" --contract_arguments SysConfig.checkSendTxPermission=true SysConfig.checkCallPermission=true SysConfig.economicalModel=1 SysConfig.checkFeeBackPlatform=true SysConfig.chainOwner=0x9a6bd7272edb238f13002911d8c93dd6bb646d15
```

The above command generates one chain with four nodes. The port defaults to 4000, 4001, 4002, 4003. The super administrator address is `0xab159a4817542585c93f01cfce9cfe6cd4cbd26a`. The operator address is
`0x9a6bd7272edb238f13002911d8c93dd6bb646d15`. The economic model is `Charge`. The transaction fee returns to the operator. All permission switches are on.

## Directory structure after initialized  configuration

The directory structure for creating four consensus nodes by `create` is as follows:

```bash
$ ls test-chain/
0 1 2 3 template
$ ls 0
address     consensus.toml  forever.toml       logs
auth.toml   data            genesis.json       network.toml
chain.toml  executor.toml   jsonrpc.toml       privkey
```

According to the given parameters, 4 nodes are generated. `test-chain/*` contains the configuration file of the nodes, as follows:

* `privkey` : stores private key
* `address` : stores address
* `*.toml` : microservice configuration file, please refer to the microservice description for details.
* `genesis.json` : genesis block file, in which, `timestamp` is in seconds; `prevhash` refers to the previous block hash, here is the default value; and `alloc` refers to the contract content deployed to the Genesis block;
* The `test-chain/template` ：template files, including the consensus node address in `test-chain/template/authorities.list`, and the system contract generation parameter in `test-chain/template/init_data.yml`, node Port address in `test-chain/template/nodes.list` and other information
* `logs` : log information
* `data` : data storage

## Modify some particular configuration

After the chain is started, that is, once the Genesis block is generated, in SysConfig, only `chainName`, `operator`, `website` can be modified at runtime. In the following operation example, we use [cita-cli] (https://github.com/cryptape/cita-cli) to demonstrate how to modifying `chainName` by administrator:

Make sure your chain is up running, and enter the command:

```shell
$ scm SysConfig setChainName --chain-name "AAA" --admin-private \ 0x5f0258a4778057a8a7d97809bd209055b2fbafa654ce7d31ec7191066b9225e6
```

After checking the transaction receipt, we successfully changed the chain name from the default `test-chain` to `AAA`.

We can query the changed result by `getMeta`, as shown in the following:

```shell
$ rpc getMetaData
```

Get the output:

```json
{
  "id": 1,
  "jsonrpc": "2.0",
  "result": {
    "blockInterval": 3000,
    "chainId": 1,
    "chainName": "AAA",
    "economicalModel": 1,
    "genesisTimestamp": 1538101178583,
    "operator": "test-operator",
    "tokenAvatar": "https://cdn.cryptape.com/icon_appchain.png",
    "tokenName": "Nervos AppChain Test Token",
    "tokenSymbol": "NATT",
    "validators": [
      "0x185e7072f53574666cf8ed8ec080e09b7e39c98f"
    ],
    "version": 1,
    "website": "https://www.example.com"
  }
}

```
`chainName` is changed.
